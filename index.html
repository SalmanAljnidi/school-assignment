<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù†Ø¸Ø§Ù… Ø¥Ø³Ù†Ø§Ø¯ Ø§Ù„Ø­ØµØµ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Tahoma;background:#0b1220;color:#fff;margin:0;padding:15px}
h2,h3{margin-top:0}
.card{background:#111a33;padding:15px;border-radius:12px;margin-bottom:15px}
input,select,button{padding:8px;border-radius:8px;border:none;width:100%;margin-top:6px}
button{background:#2a62ff;color:#fff;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border-bottom:1px solid #333;padding:6px;text-align:right;font-size:14px;vertical-align:top}
.small{color:#aaa;font-size:12px}
.badge{background:#243a88;padding:2px 8px;border-radius:10px;font-size:12px;display:inline-block;margin:2px 0}
.warn{background:#8a6d00}
.err{background:#7a0000}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:900px){.grid2{grid-template-columns:1fr}}
.inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.inline label{display:flex;gap:8px;align-items:center}
.hr{border-top:1px solid rgba(255,255,255,.12);margin:10px 0}
</style>
</head>
<body>

<h2>ğŸ“˜ Ù†Ø¸Ø§Ù… Ø¥Ø³Ù†Ø§Ø¯ Ø§Ù„Ø­ØµØµ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</h2>

<div class="card">
  <h3>1ï¸âƒ£ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±Ø­Ù„Ø©</h3>
  <div class="inline">
    <label><input type="checkbox" class="stageCB" value="primary" checked> Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</label>
    <label><input type="checkbox" class="stageCB" value="middle"> Ù…ØªÙˆØ³Ø·</label>
    <label><input type="checkbox" class="stageCB" value="secondary"> Ø«Ø§Ù†ÙˆÙŠ</label>
  </div>

  <div class="hr"></div>
  <h3>Ø¹Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„ Ù„ÙƒÙ„ ØµÙ</h3>
  <div id="sectionsBox" class="small">Ø§Ø®ØªØ± Ù…Ø±Ø­Ù„Ø©/Ù…Ø±Ø§Ø­Ù„ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙÙˆÙ.</div>
</div>

<div class="card">
  <h3>2ï¸âƒ£ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</h3>
  <input id="tName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…">
  <select id="tRank">
    <option value="24">Ù…Ù…Ø§Ø±Ø³ (24)</option>
    <option value="22">Ù…ØªÙ‚Ø¯Ù… (22)</option>
    <option value="18">Ø®Ø¨ÙŠØ± (18)</option>
  </select>
  <select id="tSpec">
    <option>Ø±ÙŠØ§Ø¶ÙŠØ§Øª</option>
    <option>Ø¹Ù„ÙˆÙ…</option>
    <option>ÙÙŠØ²ÙŠØ§Ø¡</option>
    <option>ÙƒÙŠÙ…ÙŠØ§Ø¡</option>
    <option>Ø£Ø­ÙŠØ§Ø¡</option>
    <option>Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ©</option>
    <option>Ù„ØºØ© Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</option>
    <option>ØªØ±Ø¨ÙŠØ© Ø¥Ø³Ù„Ø§Ù…ÙŠØ©</option>
    <option>Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©</option>
    <option>Ø­Ø§Ø³Ø¨</option>
    <option>Ø¨Ø¯Ù†ÙŠØ©</option>
    <option>ÙÙ†ÙŠØ©</option>
  </select>

  <button onclick="addTeacher()">â• Ø¥Ø¶Ø§ÙØ©</button>
  <button onclick="clearTeachers()" style="background:#20305f">ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</button>

  <div id="teachers" class="small" style="margin-top:10px"></div>

  <div class="hr"></div>
  <label class="inline small">
    <input type="checkbox" id="allowFallback" checked style="width:auto">
    Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø¨Ø¯Ø§Ø¦Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
  </label>
</div>

<div class="card">
  <button onclick="assign()">âš–ï¸ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯</button>
</div>

<div class="card">
  <h3>ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3>
  <div id="results" class="small">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯ Ø¨Ø¹Ø¯</div>
</div>

<div class="small">
ØªÙ†ÙˆÙŠÙ‡: Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø³Ø¨Ø© ØªÙ‚Ø¯ÙŠØ±ÙŠØ© ÙˆØªØ­ØªÙ…Ù„ Ø§Ù„ØµÙˆØ§Ø¨ ÙˆØ§Ù„Ø®Ø·Ø£.<br>
Ø³Ù„Ù…Ø§Ù† Ø§Ù„Ø¬Ù†ÙŠØ¯ÙŠ
</div>

<script>
// ================= Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =================
// Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ù‡ Ù‚ÙŠÙ… ØªØ´ØºÙŠÙ„ÙŠØ©/Ù…Ø¨Ø¯Ø¦ÙŠØ©. Ù„Ø§Ø­Ù‚Ù‹Ø§ Ù†Ø¹Ø¨ÙŠÙ‡Ø§ ÙƒÙ„Ù‡Ø§ Ù…Ù† Ù…Ù„ÙØ§ØªÙƒ Ø¨Ø¯Ù‚Ø©.
const WEEKLY = {
  primary:{
    "1":{"Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ©":7,"Ø±ÙŠØ§Ø¶ÙŠØ§Øª":6,"Ø¹Ù„ÙˆÙ…":2,"ØªØ±Ø¨ÙŠØ© Ø¥Ø³Ù„Ø§Ù…ÙŠØ©":4},
    "2":{"Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ©":7,"Ø±ÙŠØ§Ø¶ÙŠØ§Øª":6,"Ø¹Ù„ÙˆÙ…":2,"ØªØ±Ø¨ÙŠØ© Ø¥Ø³Ù„Ø§Ù…ÙŠØ©":4},
    "3":{"Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ©":7,"Ø±ÙŠØ§Ø¶ÙŠØ§Øª":6,"Ø¹Ù„ÙˆÙ…":3,"Ù„ØºØ© Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©":2},
    "4":{"Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ©":6,"Ø±ÙŠØ§Ø¶ÙŠØ§Øª":6,"Ø¹Ù„ÙˆÙ…":4,"Ù„ØºØ© Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©":3,"Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©":2}
  },
  middle:{
    "1":{"Ø±ÙŠØ§Ø¶ÙŠØ§Øª":6,"Ø¹Ù„ÙˆÙ…":4,"Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ©":5,"Ù„ØºØ© Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©":4},
    "2":{"Ø±ÙŠØ§Ø¶ÙŠØ§Øª":6,"Ø¹Ù„ÙˆÙ…":4,"Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ©":5,"Ù„ØºØ© Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©":4},
    "3":{"Ø±ÙŠØ§Ø¶ÙŠØ§Øª":6,"Ø¹Ù„ÙˆÙ…":4,"Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ©":5,"Ù„ØºØ© Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©":4}
  },
  secondary:{
    "1":{"Ø±ÙŠØ§Ø¶ÙŠØ§Øª":5,"ÙÙŠØ²ÙŠØ§Ø¡":2,"ÙƒÙŠÙ…ÙŠØ§Ø¡":2,"Ø£Ø­ÙŠØ§Ø¡":2,"Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ©":4},
    "2":{"Ø±ÙŠØ§Ø¶ÙŠØ§Øª":5,"ÙÙŠØ²ÙŠØ§Ø¡":2,"ÙƒÙŠÙ…ÙŠØ§Ø¡":2,"Ø£Ø­ÙŠØ§Ø¡":2,"Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ©":4},
    "3":{"Ø±ÙŠØ§Ø¶ÙŠØ§Øª":5,"ÙÙŠØ²ÙŠØ§Ø¡":2,"ÙƒÙŠÙ…ÙŠØ§Ø¡":2,"Ø£Ø­ÙŠØ§Ø¡":2,"Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ©":4}
  }
};

// Ø§Ù„Ù…Ø§Ø¯Ø© -> Ø§Ù„ØªØ®ØµØµØ§Øª Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø© (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©/Ø§Ù„Ø¨Ø¯Ø§Ø¦Ù„)
const SUBJECT_MAP={
  "Ø±ÙŠØ§Ø¶ÙŠØ§Øª":["Ø±ÙŠØ§Ø¶ÙŠØ§Øª"],
  "Ø¹Ù„ÙˆÙ…":["Ø¹Ù„ÙˆÙ…","Ø£Ø­ÙŠØ§Ø¡","ÙƒÙŠÙ…ÙŠØ§Ø¡","ÙÙŠØ²ÙŠØ§Ø¡"],
  "ÙÙŠØ²ÙŠØ§Ø¡":["ÙÙŠØ²ÙŠØ§Ø¡"],
  "ÙƒÙŠÙ…ÙŠØ§Ø¡":["ÙƒÙŠÙ…ÙŠØ§Ø¡"],
  "Ø£Ø­ÙŠØ§Ø¡":["Ø£Ø­ÙŠØ§Ø¡"],
  "Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ©":["Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ©"],
  "Ù„ØºØ© Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©":["Ù„ØºØ© Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©"],
  "ØªØ±Ø¨ÙŠØ© Ø¥Ø³Ù„Ø§Ù…ÙŠØ©":["ØªØ±Ø¨ÙŠØ© Ø¥Ø³Ù„Ø§Ù…ÙŠØ©"],
  "Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©":["Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©"],
  "Ø­Ø§Ø³Ø¨":["Ø­Ø§Ø³Ø¨"],
  "Ø¨Ø¯Ù†ÙŠØ©":["Ø¨Ø¯Ù†ÙŠØ©"],
  "ÙÙ†ÙŠØ©":["ÙÙ†ÙŠØ©"]
};

const STAGE_LABEL = { primary:"Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", middle:"Ù…ØªÙˆØ³Ø·", secondary:"Ø«Ø§Ù†ÙˆÙŠ" };

const teachersList = [];

// ================= Ø£Ø¯ÙˆØ§Øª =================
const $ = (id)=>document.getElementById(id);

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}

function getSelectedStages(){
  return [...document.querySelectorAll(".stageCB:checked")].map(x=>x.value);
}

// ================= Ù‚Ø³Ù… Ø§Ù„ÙØµÙˆÙ„ Ù„ÙƒÙ„ ØµÙ =================
function renderSectionsInputs(){
  const stages = getSelectedStages();
  const box = $("sectionsBox");

  if(stages.length === 0){
    box.innerHTML = "Ø§Ø®ØªØ± Ù…Ø±Ø­Ù„Ø©/Ù…Ø±Ø§Ø­Ù„ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙÙˆÙ.";
    return;
  }

  let html = `<div class="grid2">`;

  // Ù„ÙƒÙ„ Ù…Ø±Ø­Ù„Ø©: Ø£Ø¸Ù‡Ø± ØµÙÙˆÙÙ‡Ø§
  stages.forEach(stage=>{
    const grades = Object.keys(WEEKLY[stage] || {}).sort((a,b)=>Number(a)-Number(b));
    html += `<div class="card" style="margin:0;background:rgba(255,255,255,.05)">
      <div class="badge">${STAGE_LABEL[stage]}</div>
      <div class="small" style="margin-top:6px">Ø§ÙƒØªØ¨ Ø¹Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„ Ù„ÙƒÙ„ ØµÙ:</div>
      <table>
        <thead><tr><th>Ø§Ù„ØµÙ</th><th style="width:130px">Ø¹Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„</th></tr></thead>
        <tbody>
    `;
    grades.forEach(g=>{
      const inputId = `sec_${stage}_${g}`;
      html += `
        <tr>
          <td>Ø§Ù„ØµÙ ${g}</td>
          <td>
            <input id="${inputId}" type="number" min="0" value="1" />
          </td>
        </tr>`;
    });
    html += `</tbody></table></div>`;
  });

  html += `</div>
  <div class="small" style="margin-top:8px">
    Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ ØµÙ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù†Ø¯ÙƒØŒ Ø¶Ø¹ Ø¹Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„ = 0.
  </div>`;

  box.innerHTML = html;
}

document.querySelectorAll(".stageCB").forEach(cb=>{
  cb.addEventListener("change", renderSectionsInputs);
});

// ================= Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† =================
function addTeacher(){
  const name = $("tName").value.trim();
  if(!name) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…");

  teachersList.push({
    name,
    limit: +$("tRank").value,
    spec: $("tSpec").value,
    load: 0,
    details: [],      // ØªÙØ§ØµÙŠÙ„: Ù…Ø§Ø¯Ø© + ØµÙ + Ù…Ø±Ø­Ù„Ø©
    breakdown: new Map() // key = stage|grade|sub -> count
  });

  $("tName").value="";
  renderTeachers();
}

function clearTeachers(){
  teachersList.length = 0;
  renderTeachers();
  $("results").innerHTML = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯ Ø¨Ø¹Ø¯";
}

function renderTeachers(){
  if(teachersList.length===0){
    $("teachers").innerHTML = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ù„Ù…ÙŠÙ† Ø¨Ø¹Ø¯.";
    return;
  }
  $("teachers").innerHTML = teachersList.map(t =>
    `ğŸ‘¤ <b>${escapeHtml(t.name)}</b> (${escapeHtml(t.spec)}) â€” <span class="badge">${t.load}/${t.limit}</span>`
  ).join("<br>");
}

// ================= Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯ =================
function assign(){
  if(teachersList.length===0) return alert("Ø£Ø¶Ù Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø£ÙˆÙ„Ø§Ù‹.");

  const stages = getSelectedStages();
  if(stages.length===0) return alert("Ø§Ø®ØªØ± Ù…Ø±Ø­Ù„Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");

  const allowFallback = $("allowFallback").checked;

  // Ø¥Ø¹Ø§Ø¯Ø© ØªØµÙÙŠØ±
  teachersList.forEach(t=>{
    t.load=0;
    t.details=[];
    t.breakdown = new Map();
  });

  let warnings = [];
  let unassigned = [];
  let units = [];

  // ØªÙˆÙ„ÙŠØ¯ â€œÙˆØ­Ø¯Ø§Øª Ø­ØµØµâ€ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„ Ù„ÙƒÙ„ ØµÙ
  stages.forEach(stage=>{
    const grades = Object.keys(WEEKLY[stage] || {});
    grades.forEach(grade=>{
      const secInput = document.getElementById(`sec_${stage}_${grade}`);
      const sections = secInput ? Math.max(0, +secInput.value || 0) : 0;
      if(sections===0) return;

      const plan = WEEKLY[stage][grade] || {};
      Object.entries(plan).forEach(([sub, count])=>{
        const total = (count||0) * sections;
        for(let i=0;i<total;i++){
          units.push({stage, grade, sub});
        }
      });
    });
  });

  if(units.length===0){
    $("results").innerHTML = `<span class="badge err">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ Ù„Ù„ØªÙˆØ²ÙŠØ¹</span><br>ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„ Ù„ÙƒÙ„ ØµÙ.`;
    return;
  }

  // Ø±ØªØ¨ Ø§Ù„Ø­ØµØµ Ø¨Ø­ÙŠØ« Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø£Ù‚Ù„ ØªÙˆÙØ±Ù‹Ø§ ÙÙŠ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ØªØªÙˆØ²Ø¹ Ø£ÙˆÙ„Ù‹Ø§
  const eligibleCountCache = new Map();
  function eligibleCount(sub){
    if(eligibleCountCache.has(sub)) return eligibleCountCache.get(sub);
    const allowed = SUBJECT_MAP[sub] || [];
    const c = teachersList.filter(t=>allowed.includes(t.spec)).length;
    eligibleCountCache.set(sub, c);
    return c;
  }
  units.sort((a,b)=> eligibleCount(a.sub) - eligibleCount(b.sub));

  // Ø§Ù„ØªÙˆØ²ÙŠØ¹
  for(const u of units){
    const allowedSpecs = SUBJECT_MAP[u.sub] || [];

    // 1) Ø§Ù„Ù…ØªØ®ØµØµÙŠÙ† ÙÙ‚Ø·
    let candidates = teachersList.filter(t=>allowedSpecs.includes(t.spec));

    // Ø¥Ø°Ø§ Ù…Ø§ ÙÙŠÙ‡ Ù…ØªØ®ØµØµÙŠÙ†:
    if(candidates.length===0){
      if(!allowFallback){
        unassigned.push(u);
        continue;
      }
      // 2) Ø¨Ø¯Ø§Ø¦Ù„: Ø£ÙŠ Ù…Ø¹Ù„Ù… (Ø­Ù„ Ø£Ø®ÙŠØ±)
      candidates = [...teachersList];
    }

    // Ø§Ù„Ø£ÙØ¶Ù„: Ù„Ø§ Ù†ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù†ØµØ§Ø¨ Ø¥Ø°Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø­Ø¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†ØµØ§Ø¨
    let within = candidates.filter(t=>t.load < t.limit);
    if(within.length===0){
      // Ù…Ø§ ÙÙŠÙ‡ Ø£ÙŠ Ø£Ø­Ø¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†ØµØ§Ø¨ -> Ù†ÙƒÙ…Ù„ ÙˆÙ†Ø®ØªØ§Ø± Ø§Ù„Ø£Ù‚Ù„ Ù†Ø³Ø¨Ø© (Ù‚Ø¯ ÙŠØªØ¬Ø§ÙˆØ²)
      within = candidates;
    }

    // Ø§Ø®ØªØ± Ø§Ù„Ø£Ù‚Ù„ Ù†Ø³Ø¨Ø© (load/limit) Ø«Ù… Ø§Ù„Ø£Ù‚Ù„ load
    within.sort((a,b)=>{
      const ra = a.load / a.limit;
      const rb = b.load / b.limit;
      if(ra!==rb) return ra-rb;
      return a.load - b.load;
    });

    const chosen = within[0];
    chosen.load++;

    const key = `${u.stage}|${u.grade}|${u.sub}`;
    chosen.breakdown.set(key, (chosen.breakdown.get(key)||0) + 1);

    // ØªØ­Ø°ÙŠØ± Ø¨Ø¯ÙŠÙ„
    if(!allowedSpecs.includes(chosen.spec)){
      warnings.push(`Ø§Ø³ØªØ®Ø¯Ù… Ø¨Ø¯ÙŠÙ„: ${chosen.name} (${chosen.spec}) Ù„Ù…Ø§Ø¯Ø© ${u.sub} â€” ${STAGE_LABEL[u.stage]} Ø§Ù„ØµÙ ${u.grade}`);
    }
  }

  // Ø¨Ù†Ø§Ø¡ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶
  teachersList.forEach(t=>{
    const items = [...t.breakdown.entries()]
      .map(([k,c])=>{
        const [stage, grade, sub] = k.split("|");
        return {stage, grade, sub, c};
      })
      .sort((a,b)=> a.stage.localeCompare(b.stage) || Number(a.grade)-Number(b.grade) || a.sub.localeCompare(b.sub));

    t.details = items.map(it=>`â€¢ ${escapeHtml(it.sub)} â€” ${STAGE_LABEL[it.stage]} Ø§Ù„ØµÙ ${it.grade} (${it.c})`);
  });

  renderTeachers();
  renderResults(warnings, unassigned, units.length);
}

function renderResults(warnings, unassigned, totalUnits){
  let html = `<div class="inline">
    <span class="badge">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­ØµØµ Ø§Ù„Ù…ÙˆØ²Ø¹Ø©: ${totalUnits - unassigned.length}</span>
    <span class="badge ${unassigned.length? "err":" "}">ØºÙŠØ± Ù…ØºØ·Ø§Ø©: ${unassigned.length}</span>
    <span class="badge ${warnings.length? "warn":" "}">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¨Ø¯Ø§Ø¦Ù„: ${warnings.length}</span>
  </div><div class="hr"></div>`;

  // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†
  html += `<table>
    <thead><tr><th>Ø§Ù„Ù…Ø¹Ù„Ù…</th><th>Ø§Ù„ØªØ®ØµØµ</th><th>Ø§Ù„Ù†ØµØ§Ø¨</th><th>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯</th></tr></thead>
    <tbody>`;

  teachersList.forEach(t=>{
    const over = t.load > t.limit;
    html += `<tr>
      <td><b>${escapeHtml(t.name)}</b></td>
      <td>${escapeHtml(t.spec)}</td>
      <td><span class="badge ${over?"err":""}">${t.load}/${t.limit}</span></td>
      <td>${t.details.length ? t.details.join("<br>") : `<span class="small">â€”</span>`}</td>
    </tr>`;
  });

  html += `</tbody></table>`;

  // ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
  if(warnings.length){
    html += `<div class="hr"></div><div class="badge warn">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª (Ø¨Ø¯Ø§Ø¦Ù„)</div><div class="small" style="margin-top:6px">`;
    warnings.slice(0, 200).forEach(w=>{ html += `âš ï¸ ${escapeHtml(w)}<br>`; });
    if(warnings.length>200) html += `<span class="small">... ØªÙ… Ø¹Ø±Ø¶ Ø£ÙˆÙ„ 200 ØªÙ†Ø¨ÙŠÙ‡ ÙÙ‚Ø·</span>`;
    html += `</div>`;
  }

  // ØºÙŠØ± Ù…ØºØ·Ø§Ø©
  if(unassigned.length){
    // ØªØ¬Ù…ÙŠØ¹ ØºÙŠØ± Ø§Ù„Ù…ØºØ·Ù‰
    const map = new Map();
    unassigned.forEach(u=>{
      const k = `${u.stage}|${u.grade}|${u.sub}`;
      map.set(k, (map.get(k)||0) + 1);
    });
    const items = [...map.entries()].map(([k,c])=>{
      const [stage, grade, sub] = k.split("|");
      return {stage, grade, sub, c};
    }).sort((a,b)=> a.stage.localeCompare(b.stage) || Number(a.grade)-Number(b.grade) || a.sub.localeCompare(b.sub));

    html += `<div class="hr"></div><div class="badge err">Ø­ØµØµ ØºÙŠØ± Ù…ØºØ·Ø§Ø©</div><div class="small" style="margin-top:6px">`;
    items.forEach(it=>{
      html += `âŒ ${escapeHtml(it.sub)} â€” ${STAGE_LABEL[it.stage]} Ø§Ù„ØµÙ ${it.grade}: ${it.c} Ø­ØµØ©<br>`;
    });
    html += `</div>`;
  }

  $("results").innerHTML = html;
}

// ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
renderSectionsInputs();
renderTeachers();
</script>
</body>
</html>
